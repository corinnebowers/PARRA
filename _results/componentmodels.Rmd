---
title: "componentmodels"
output:
  html_document:
    toc: true 
    toc_float: true
    #toc_depth: 3  
    code_folding: hide
    number_sections: true 
    theme: spacelab   #https://www.datadreaming.org/post/r-markdown-theme-gallery/
    highlight: tango  #https://www.garrickadenbuie.com/blog/pandoc-syntax-highlighting-examples/
---

The purpose of this script is to ...

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = 'D:/1-PARRA/')
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.show = 'hold', fig.align = 'center')

```

```{r}
## setup information
source('_data/setup.R')

## set parallel backend
num_cores <- 5

## load catalog
load('_data/catalog/catalog.Rdata')

## load location information
load('_data/lisflood/dem.Rdata')
load('_data/aoi/aoi.Rdata')
load('_data/depthdamage/depthdamage.Rdata')

## load required packages
require(dataRetrieval)
require(ggpubr)
require(grid)
require(gridExtra)
require(gt)

## set random seed for reproducibility
set.seed(7395)

```

# f(AR)

## Identify case study storm
```{r}
casestudy <- catalog %>% filter(start_day == ymd('2019-02-25'))
print(casestudy)

```


## Generate AR figure

This figure summarizes the historic catalog generated for Sonoma County, and highlights the 2019 case study AR in relation to the rest of the catalog.

```{r}
g.void <- ggplot() + theme_void() + 
  theme(plot.margin = margin(2,2,2,2))

g.ivt <- ggplot(catalog) + 
  geom_histogram(aes(x = IVT_max), color = 'black', fill = 'grey90', 
                 bins = sqrt(nrow(catalog)), boundary = 250, size = 0.25) + 
  scale_x_continuous('Maximum IVT (kg/m/s)', breaks = seq(0, 1e5, 250),
                     expand = c(0,0), limits = c(250,1500)) + 
  scale_y_origin() + 
  coord_cartesian(xlim = c(250, NA), clip = 'off') + 
  theme(axis.title.y = element_blank(), axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), axis.line.y = element_line(color = NA),
        plot.margin = margin(2,2,2,2))

g.dur <- ggplot(catalog) + 
  geom_histogram(aes(x = duration), color = 'black', fill = 'grey90',
                 bins = sqrt(nrow(catalog)), boundary = 0, size = 0.25) + 
  scale_x_continuous('Storm Duration (hrs)', expand = c(0,0), 
                     breaks = seq(0, 240, 24), minor_breaks = seq(0, 240, 24)) + 
  scale_y_origin() +
  coord_flip(xlim = c(0,192), clip = 'off') +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), axis.line.x = element_line(color = NA),
        plot.margin = margin(2,2,2,2))
```

```{r}
## create category underlay
IVT_breaks <- seq(250, 1250, 250) + 125
duration_breaks <- seq(0, 168, 24) + 12
df <- expand.grid(IVT = IVT_breaks, duration = duration_breaks)
ARcat <- function(IVT, duration) {
  if (duration >= 48) {
    case_when(
      IVT>=1000 ~ 5, IVT>=750 ~ 4, IVT>=500 ~ 3, TRUE ~ 2)
  } else if (duration >= 24) {
    case_when(
      IVT>=1250 ~ 5, IVT>=1000 ~ 4, IVT>=750 ~ 3, IVT>=500 ~ 2, TRUE ~ 1)
  } else {
    case_when(
      IVT>=1250 ~ 4, IVT>=1000 ~ 3, IVT>=750 ~ 2, IVT>=500 ~ 1, TRUE ~ 0)
  }
}
for (i in 1:nrow(df)) {df$cat[i] <- ARcat(df$IVT[i], df$duration[i])}
df <- df %>% mutate(cat = ifelse(cat == 0, 1, cat))

```

```{r}
g <- ggplot(df) + 
  geom_raster(aes(x = IVT, y = duration, fill = factor(cat)), alpha = 0.75) + 
  geom_point(data = catalog, aes(x = IVT_max, y = duration), color = 'grey10', size = 0.5) + 
  geom_vline(xintercept = casestudy$IVT_max, linetype = 'dashed') + 
  geom_hline(yintercept = casestudy$duration, linetype = 'dashed') + 
  scale_fill_scico_d('Intensity \nCategory', palette = 'roma', direction = -1) + 
  scale_x_continuous('Maximum IVT (kg/m/s)', limits = c(250, NA), expand = c(0,0), 
                     breaks = seq(250, 1500, 250), minor_breaks = seq(250, 1500, 250)) + 
  scale_y_continuous('Storm Duration (hrs)', expand = c(0,0), 
                     breaks = seq(0, 240, 24), minor_breaks = seq(0, 240, 24)) + 
  coord_cartesian(ylim = c(0,192)) + 
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), axis.text.y = element_blank(),
        plot.margin = margin(2,20,2,2))
```

```{r}
plot_grid(g, g.ivt, nrow = 2, align = 'v', axis = 'lr', rel_heights = c(3,1)) %>% 
  plot_grid(
    plot_grid(g.dur, g.void, nrow = 2, rel_heights = c(3,1)), ., 
    align = 'h', rel_widths = c(1,3)) 
ggsave('_figures/fig03_AR.png', height = 5.75, width = 8.3, units = 'cm', dpi = 600)

```


# f(PRCP|AR)

## Generate simulated precipitation values
```{r}
## define pinch point AR using the observed AR characteristics for the case study storm
AR <- casestudy %>% 
  transmute(n.AR = 1, IVT_max, duration)

## generate probabilistic realizations of PRCP
source('_scripts/PRCP_sherlock.R')
catalog <- catalog %>% 
  rename(precip_obs = precip_mm, runoff_obs = runoff_mm, Qp_obs = Qp_m3s)
precip <- 
  generate_precip(
    AR = AR, 
    catalog = catalog,
    probabilistic = TRUE,
    n.precip = 1e3)

## display fitted model values
model.prcp$tau
model.prcp$coefficients %>% scientific(digits = 4)

```

### Plot precipitation scatterplots
```{r}
g1 <- ggplot(catalog) + 
  geom_point(aes(x = IVT_max, y = precip_obs), size = 0.5) + 
  geom_point(data = casestudy, aes(x = IVT_max, y = precip_mm), color = 'red') + 
  geom_line(aes(x = IVT_max,
    y = catalog %>% select(IVT_max) %>% 
      mutate(duration = 6) %>% predict.rq(model.prcp, .),
    color = '6'), size = 0.75) + 
  geom_line(aes(x = IVT_max,
    y = catalog %>% select(IVT_max) %>% 
      mutate(duration = 24) %>% predict.rq(model.prcp, .),
    color = '24'), size = 0.75) + 
  geom_line(aes(x = IVT_max,
    y = catalog %>% select(IVT_max) %>% 
      mutate(duration = 72) %>% predict.rq(model.prcp, .),
    color = '72'), size = 0.75) + 
  scale_x_continuous(
    expression(paste('Maximum IVT (kg⋅', m^{-1}, s^{-1}, ')')),
    limits = c(250, NA), expand = c(0,0), 
    breaks = seq(250, 1500, 250), minor_breaks = seq(250, 1500, 250)) + 
  scale_y_origin('Storm Total Precipitation (mm)') + 
  scale_color_manual('Duration (hrs)', 
    values = scico(n = 4, palette = 'davos')[1:3], 
    breaks = c('72', '24', '6')) + 
  coord_cartesian(clip = 'off') + 
  theme(legend.position = 'bottom', 
        legend.text = element_text(margin = margin(0, 0, 0, -4)))

g2 <- ggplot(catalog) + 
  geom_point(aes(x = duration, y = precip_obs), size = 0.5) + 
  geom_point(data = casestudy, aes(x = duration, y = precip_mm), color = 'red') + 
  geom_line(aes(x = duration,
    y = catalog %>% select(duration) %>% 
      mutate(IVT_max = 250) %>% predict.rq(model.prcp, .),
    color = '250'), size = 0.75) + 
  geom_line(aes(x = duration,
    y = catalog %>% select(duration) %>% 
      mutate(IVT_max = 500) %>% predict.rq(model.prcp, .),
    color = '500'), size = 0.75) + 
  geom_line(aes(x = duration,
    y = catalog %>% select(duration) %>% 
      mutate(IVT_max = 1000) %>% predict.rq(model.prcp, .),
    color = '1000'), size = 0.75) + 
  scale_x_continuous(
    'Storm Duration (hrs)', expand = c(0,0), 
    breaks = seq(0, 240, 24), minor_breaks = seq(0, 240, 24)) + 
  scale_y_origin('Storm Total Precipitation (mm)') + 
  scale_color_manual(expression(paste('Max IVT (kg⋅', m^{-1}, s^{-1}, ')')), 
    values = scico(n = 4, palette = 'davos')[1:3], 
    breaks = c('1000', '500', '250')) + 
  coord_cartesian(clip = 'off') + 
  theme(legend.position = 'bottom', 
        legend.text = element_text(margin = margin(0, 0, 0, -4)))

```

### Plot precipitation quantile plot
```{r}
catalog <- catalog %>% 
  mutate(precip_sim = predict.rq(model.prcp, catalog)) 
precip.max <- max(c(max(catalog$precip_obs), max(catalog$precip_sim)))

g3 <- ggplot(catalog) + 
  geom_point(aes(x = sort(precip_obs), y = sort(precip_sim)), size = 0.75) + 
  geom_parity() + 
  coord_cartesian(xlim = c(NA, precip.max), ylim = c(NA, precip.max)) + 
  scale_x_continuous('Observed Precipitation Quantile (mm)', 
    expand = expansion(mult = c(0, 0.05))) + 
  scale_y_continuous('Simulated Precipitation Quantile (mm)', 
    expand = expansion(mult = c(0, 0.05))) + 
  theme_bw_custom()

## calculate K-S statistic here
  
```


### Plot observed vs. simulated precipitation histogram
```{r}
g4 <- ggplot(precip) + 
  geom_histogram(aes(x = precip_sim, y = ..count../nrow(precip)), 
                 color = 'black', fill = 'grey90', 
                 bins = sqrt(nrow(precip)), boundary = 0, size = 0.25) + 
  geom_vline(xintercept = casestudy$precip_mm, linetype = 'dashed') + 
  annotate(geom = 'text', 
           x = casestudy$precip_mm - 20, y = 0.055, 
           label = 'Observed Precipitation', family = 'Segoe UI', size = 8/.pt,
           angle = 90) + 
  scale_x_origin('Storm Total Precipitation (mm)') + 
  scale_y_origin('Frequency of Occurrence') + 
  coord_cartesian(xlim = c(0, precip.max))

## display event percentile
sum(casestudy$precip_mm > precip$precip_sim)/nrow(precip)

```

```{r}
plot_grid(
  plot_grid(
    g1 + theme(legend.position = 'none'), g2 + theme(legend.position = 'none'), 
    nrow = 1, align = 'h', rel_widths = c(1,1),
    labels = c('(a)', '(b)'), label_fontfamily = 'Segoe UI', label_size = 12,
    label_x = 0.2, label_y = 0.95), 
  plot_grid(get_legend(g1), get_legend(g2), nrow = 1, rel_widths = c(1,1)),
  plot_grid(
    g3, g4, nrow = 1, align = 'h',
    labels = c('(c)', '(d)'), label_fontfamily = 'Segoe UI', label_size = 12,
    label_x = 0.2, label_y = 0.95), 
  nrow = 3, 
  rel_heights = c(9,1,10))
ggsave('_figures/fig04_precip.png', width = 12, height = 12, units = 'cm')

```


# f(Q|PRCP, HC)

```{r}
source('_scripts/Q_sherlock.R')

```

## Generate simulated values for HC (antecedent soil moisture)
```{r}
precip <- generate_soilmoisture(precip, catalog, n.hc = 1)

```

```{r}
## find percentile of 2019 event
plnorm(casestudy$sm, meanlog = fit.sm[1], sdlog = fit.sm[2])

```


#### Plot observed soil moisture data vs. simulated lognormal distribution
```{r}
g5 <- data.frame(dx = seq(0, 200, length.out = 1e3)) %>% 
  mutate(fit = dlnorm(dx, meanlog = fit.sm[1], sdlog = fit.sm[2])) %>% 
  ggplot() + 
  geom_histogram(
    data = catalog, 
    aes(x = sm, y = ..density.., fill = 'Observed Historic Catalog'),
    color = 'black', size = 0.25) + 
  geom_line(aes(x = dx, y = fit, size = 'Lognormal Distribution')) + 
  scale_fill_manual(values = 'grey90') + 
  scale_size_manual(values = 0.5) + 
  scale_x_origin('Soil Moisture (mm)') + 
  scale_y_origin('Frequency of Occurrence') + 
  theme(legend.title = element_blank(), 
        legend.position = 'bottom',
        legend.margin = margin(0,0,0,0))

```

### Plot lognormal quantile plot
```{r}
temp <- catalog %>% 
  select(sm) %>% 
  arrange(sm) %>% 
  mutate(p = (1:nrow(.))/(nrow(.)+1)) %>% 
  mutate(fit = qlnorm(p, meanlog = fit.sm[1], sdlog = fit.sm[2]))
xmax <- max(c(max(temp$sm), max(temp$fit)))
ggplot(temp) + 
  geom_point(aes(x = fit, y = sm)) + 
  scale_x_origin('Theoretical Lognormal Quantile') + 
  scale_y_origin('Observed Historic Catalog') + 
  geom_parity() + coord_fixed(xlim = c(0, xmax), ylim = c(0, xmax)) + 
  theme_bw() + theme(text = element_text(family = 'Segoe UI'))

```

## Generate simulated values for Qp & tp

```{r}
## define pinch point PRCP using the observed storm-total precipitation for the case study storm
precip <- casestudy %>% 
  transmute(n.AR = 1, n.precip = 1, IVT_max, duration, precip_mm, sm) %>% 
  mutate(p = plnorm(q = sm, meanlog = fit.sm[1], sdlog = fit.sm[2]))

## generate probabilistic realizations of R, runoff
runoff <- 
  generate_runoff(
    precip = precip, 
    catalog = catalog, 
    probabilistic = TRUE,
    n.runoff = 1e3)

## generate probabilistic realizations of Q, streamflow 
hydrograph <-
  generate_hydrograph(
    precip = precip,
    runoff = runoff,
    catalog = catalog,
    probabilistic = TRUE,
    n.hydro = 1)

```

```{r}
## prove that this is better than the default
caret::R2(
  catalog$runoff_obs * (readNWISsite(11463500)$drain_area_va * 1609.344^2) / catalog$duration,
  catalog$Qp_obs)
caret::R2(predict(model.Qp), catalog$Qp_obs)

```

#### Plot observed time to peak data vs. simulated lognormal distribution
```{r}
g6 <- data.frame(dx = seq(0, 60, length.out = 1e3)) %>% 
  mutate(fit = dlnorm(dx, meanlog = fit.tp[1], sdlog = fit.tp[2])) %>% 
  ggplot() + 
  geom_histogram(
    data = catalog, 
    aes(x = tp_hrs, y = ..density.., fill = 'Observed Historic Catalog'),
    color = 'black', size = 0.25) + 
  geom_line(aes(x = dx, y = fit, size = 'Lognormal Distribution')) + 
  scale_fill_manual(values = 'grey90') + 
  scale_size_manual(values = 0.5) + 
  scale_x_origin('Time to Peak Streamflow @ USGS 11463500 (hrs)') + 
  scale_y_origin('Frequency of Occurrence') + 
  theme(legend.title = element_blank())

```


```{r}
plot_grid(
  g5 + theme(legend.position = 'none'), g6 + theme(legend.position = 'none'),
  align = 'v', nrow = 2,
  labels = c('(a)', '(b)'), label_fontfamily = 'Segoe UI', label_size = 12,
  label_x = 0.15, label_y = 0.95) %>% 
  plot_grid(get_legend(g5), nrow = 2, rel_heights = c(12,1))
ggsave('_figures/fig05_lognormal.png', width = 8.3, height = 10, units = 'cm')

```

### Plot peak streamflow quantile plot
```{r}
catalog <- catalog %>% 
  rename(runoff = runoff_obs, precip = precip_obs) %>% 
  mutate(Qp_sim = predict(model.Qp, .)) 
Qp.max <- max(c(max(catalog$Qp_obs), max(catalog$Qp_sim)))

g7 <- ggplot(catalog) + 
  geom_point(aes(x = sort(Qp_obs), y = sort(Qp_sim)), size = 0.75) + 
  geom_parity() + 
  coord_cartesian(xlim = c(NA, Qp.max), ylim = c(NA, Qp.max)) + 
  scale_x_continuous(
    expression(paste('Observed ', Q[p], ' Quantile (', m^{3}, s^{-1}, ')')), 
    expand = expansion(mult = c(0, 0.05)), labels = comma) + 
  scale_y_continuous(
    expression(paste('Simulated ', Q[p], ' Quantile (', m^{3}, s^{-1}, ')')), 
    expand = expansion(mult = c(0, 0.05)), labels = comma) + 
  theme_bw_custom() 

```

### Plot real vs. simulated streamflow hydrograph
```{r}
## download real gauge info
param <- c('00060', '00065'); names(param) <- c('discharge_cfs', 'gageht_ft')
statcode <- c('00001', '00002', '00003', '00008'); names(statcode) <- c('max', 'min', 'mean', 'median')
sites <- readNWISsite(11463500)
flow <- readNWISdata(
  sites = 11463500, parameterCd = param, 
  startDate = ymd(casestudy$start_day) - days(1), 
  endDate = ymd(casestudy$end_day) + days(2), 
  service = 'iv', tz = 'America/Los_Angeles') %>% 
  renameNWISColumns

## set constants
baseflow <- 3
simlength <- 10 * 24 * 3600
t <- seq(0, simlength, 360)
m <- 4

## create synthetic streamflow timeseries records
num_cores <- 5
cl <- parallel::makeCluster(num_cores)
registerDoSNOW(cl)
pb <- txtProgressBar(min = 0, max = nrow(hydrograph), style = 3)
flow.sim <- 
  foreach (i = 1:nrow(hydrograph), .packages = 'lubridate',
    .options.snow = list(progress = function(n) setTxtProgressBar(pb, n))) %dopar% {
    Qp <- hydrograph$Qp_sim[i]
    tp <- hydrograph$tp_sim[i]*60^2
    q <- apply(cbind(exp(m*(1-t/tp)) * (t/tp)^m * Qp, rep(baseflow, length(t))), 1, max)
    sim <- data.frame(t = lubridate::now() + seconds(t), q = q)
    dt <- sim[which.max(sim$q), 't'] - flow[which.max(flow$Flow_Inst), 'dateTime']
    sim$t <- sim$t - dt
    sim
  } %>% reduce(full_join, by = 't')
stopCluster(cl)
flow.sim[is.na(flow.sim)] <- baseflow

## calculate statistics of synthetic streamflow timeseries records
sequence <- flow.sim$t
flow.matrix <- flow.sim %>% select(-t) %>% as.matrix %>% unname
flow.df <- data.frame(t = sequence) %>% 
  mutate(min = apply(flow.matrix, 1, Min), 
         q05 = apply(flow.matrix, 1, function(x) quantile(x, 0.05, na.rm = TRUE)),
         q25 = apply(flow.matrix, 1, function(x) quantile(x, 0.25, na.rm = TRUE)),
         med = apply(flow.matrix, 1, function(x) median(x, na.rm = TRUE)),
         mean = apply(flow.matrix, 1, Mean), 
         q75 = apply(flow.matrix, 1, function(x) quantile(x, 0.75, na.rm = TRUE)),
         q95 = apply(flow.matrix, 1, function(x) quantile(x, 0.95, na.rm = TRUE)), 
         max = apply(flow.matrix, 1, Max)) %>% 
  mutate(min = ifelse(is.infinite(min), NA, min),
         mean = ifelse(is.nan(mean), NA, mean), 
         max = ifelse(is.infinite(max), NA, max))

```

```{r}
g8 <- ggplot(flow.df) + 
  geom_ribbon(aes(x = t, ymin = q05, ymax = q95, fill = '90th p.')) + 
  geom_ribbon(aes(x = t, ymin = q25, ymax = q75, fill = '50th p.')) +
  geom_line(aes(x = t, y = med, fill = 'Median'), color = 'grey25') + 
  scale_fill_manual('Simulated \nStreamflow',
    breaks = c('Median', '50th p.', '90th p.'),
    values = c('grey25', 'grey70', 'grey90')) + 
  geom_line(data = flow, 
    aes(x = ymd_hms(dateTime, tz = 'America/Los_Angeles'), y = Flow_Inst/mft^3, 
        color = '2019 Event'), size = 0.75) + 
  scale_color_manual('Recorded \nStreamflow', values = 'black') + 
  scale_y_origin(expression(paste('Streamflow (', m^{3}, s^{-1}, ')')), labels = comma) + 
  scale_x_datetime('Date',
    limits = c(ymd_hms('2019-02-24 12:00:00PM', tz = 'America/Los_Angeles'),
               ymd_hms('2019-03-02 12:00:00AM', tz = 'America/Los_Angeles')), 
    date_breaks = 'day', date_labels = '%b %d', expand = c(0,0)) + 
  theme(legend.position = c(0.9,0.65), 
        legend.margin = margin(-1, 0, -1, 0), 
        plot.margin = margin(10,25,10,10))

```

```{r}
plot_grid(
  g7, g8, nrow = 2, align = 'v',
  labels = c('(a)', '(b)'), label_fontfamily = 'Segoe UI', label_size = 12,
  label_x = 0.2, label_y = 0.95,
  rel_heights = c(5,4))
ggsave('_figures/fig06_hydrograph.png', width = 8.3, height = 12, units = 'cm')

```


# f(INUN|Q) 

## Validate river channel 

* defined all necessary files in Sherlock using $generate_files.R$
* created a LISFLOOD inundation file with $run_lisflood.sh$

```{r}
## identify relevant USGS gages
param <- c('00060', '00065'); names(param) <- c('discharge_cfs', 'gageht_ft')
statcode <- c('00001', '00002', '00003', '00008'); names(statcode) <- c('max', 'min', 'mean', 'median')
gages <- whatNWISsites(stateCd = '06', countyCd = '097') %>% 
  filter(grepl('RUSSIAN', station_nm)) %>% 
  filter(str_length(site_no) == 8)
temp <- readNWISdata(
  sites = gages$site_no, parameterCd = param, 
  startDate = casestudy$start_day, 
  endDate = ymd(casestudy$end_day) + days(1), 
  service = 'iv', tz = 'America/Los_Angeles') %>% 
  renameNWISColumns %>% 
  filter(!is.na(Flow_Inst) | !is.na(GH_Inst))
gages <- gages %>% 
  filter(site_no %in% unique(temp$site_no)) %>% 
  filter(site_no != 11463500) %>% 
  arrange(site_no)

```

```{r}
## plot gages of interest
g9 <- readNWISsite(siteNumbers = c(11463500, gages$site_no[-2])) %>% 
  st_as_sf(coords = c('dec_long_va', 'dec_lat_va'), crs = 4269) %>% 
  st_transform(6417) %>% 
  ggplot() + 
  geom_sf(data = st_union(sonoma), color = 'grey50', fill = 'grey95') + 
  geom_sf(data = aoi, fill = 'grey50', alpha = 0.1, color = 'black') + 
  geom_sf(data = russian %>% st_transform(6417) %>% st_crop(sonoma), 
          color = 'grey30', size = 0.75) + 
  geom_sf(aes(color = factor(site_no)), size = 2) + 
  scale_color_manual('USGS Gauge', guide = FALSE,
                     values = c('black', scico(n = 5, palette = 'roma')[-3])) + 
  theme_void() +
  theme(text = element_text(family = 'Segoe UI'),
        plot.title = element_text(family = 'Segoe UI Semibold'))
ggsave('_figures/fig07_map.png', width = 6, height = 8, units = 'cm')

```

```{r}
## load real discharge & stage height data
flow.obs <- readNWISdata(
  sites = gages$site_no, parameterCd = param, 
  startDate = ymd(casestudy$start_day) - days(30), 
  endDate = ymd(casestudy$end_day) + days(7), 
  service = 'iv', tz = 'America/Los_Angeles') %>% 
  renameNWISColumns %>% 
  filter(!is.na(Flow_Inst) | !is.na(GH_Inst))

## load simulated stage data
stage <-
  read.table('_sensitivity/surrogate/sherlock_casestudy/results/casestudy.stage', skip = 11) %>%
  setNames(c('t', gages$site_no)) %>%
  pivot_longer(cols = -t, names_to = 'site_no', values_to = 'h') %>%
  mutate(dateTime = flow.obs$dateTime[1] + seconds(t)) %>%  # 
  right_join(flow.obs %>% select(dateTime, site_no, GH_Inst), by = c('dateTime', 'site_no')) %>% 
  rename(h.obs = GH_Inst, h.sim = h) %>% 
  mutate(h.obs = h.obs/mft)

## correct the linear offset in stage timeseries
bed <- raster('_sensitivity/surrogate/sherlock_casestudy/results/casestudy_SGC_bedZ.asc', 
              crs = projection(aoi))
bed[][bed[]>1e9] <- NA

gages.elev <- gages %>%
  st_as_sf(coords = c('dec_long_va', 'dec_lat_va'), crs = 4269) %>%
  elevatr::get_elev_point() %>%
  st_transform(6417) %>% 
  mutate(lisflood_m = raster::extract(bed, ., small = TRUE)) %>%
  mutate(site_no = toNumber(site_no)) %>% 
  left_join(readNWISsite(gages$site_no) %>% select(site_no, alt_va, alt_datum_cd),
            by = 'site_no')

## get the datum conversion (lisflood/SonomaVegMap is in NAVD88 (Geoid 12A))
gages.elev <- gages.elev %>%
  mutate(datum_conversion_m = c(0, NA, 0.873, 0.854, 0.863)) %>%
  mutate(usgs_m = alt_va/mft + datum_conversion_m)

# ggplot(gages.elev) + geom_point(aes(x = elevation, y = lisflood_m)) + geom_parity()
# ggplot(gages.elev) + geom_point(aes(x = elevation, y = usgs_m)) + geom_parity()
# ggplot(gages.elev) + geom_point(aes(x = lisflood_m, y = usgs_m)) + geom_parity()

```

```{r}
## plot real vs. simulated stage height
stage.plot <- stage %>% 
  mutate(site_no = toNumber(site_no)) %>% 
  filter(site_no != 11463980) %>% 
  left_join(gages.elev, by = 'site_no') %>% 
  mutate(h.sim = h.sim-usgs_m+lisflood_m) %>% 
  filter(dateTime >= ymd_hms('2019-02-23 12:00:00AM') & 
           dateTime <= ymd_hms('2019-03-04 12:00:00AM')) 
offset <- mean(stage.plot$h.obs) - mean(stage.plot$h.sim)

# map(.x = unique(stage.plot$site_no), .f = function(.x) {
#   ggplot(stage.plot %>% filter(site_no == .x)) + 
#     geom_rect(aes(xmin = ymd_hms('2019-02-25 12:00:00AM'), 
#                   xmax = ymd_hms('2019-02-28 12:00:00AM'),
#                   ymin = 0, ymax = max(c(max(h.obs), Max(h.sim)))*1.05),
#               fill = 'grey90', alpha = 0.25) + 
#     geom_line(aes(x = dateTime, y = h.obs, linetype = 'Recorded'), size = 1) +
#     geom_line(aes(x = dateTime, y = h.sim, linetype = 'Simulated'), size = 1) + 
#     ggtitle(waiver(), subtitle = paste0('USGS Gage ', .x)) + 
#     scale_linetype_manual('Data Type', values = c(3,1)) + 
#     scale_x_datetime(labels = function(z) gsub("^0", "", strftime(z, "%m/%d")),
#                      date_breaks = 'day', minor_breaks = 'day') +
#     scale_y_origin('Water Surface', labels = comma_format(accuracy = 1, suffix = ' m')) + 
#     theme_bw() + 
#     theme(text = element_text(family = 'Segoe UI'), 
#           title = element_text(family = 'Segoe UI'), 
#           axis.title.x = element_blank(),
#           axis.text.x = element_text(angle = 90, hjust = 1),
#           legend.title = element_blank(), legend.margin = margin(-5, 0, -5, 0),
#           legend.position = 'bottom')
#   # ggsave(paste0('C:/Users/cbowers/desktop/gage', .x, '.png'), width = 3, height = 2)
# }) %>% plot_grid(nrow = 4)
  
g10 <- ggplot(stage.plot) + 
  geom_rect(aes(xmin = ymd_hms('2019-02-25 12:00:00AM'), 
                xmax = ymd_hms('2019-02-28 12:00:00AM'),
                ymin = 0, ymax = max(c(max(h.obs), Max(h.sim+offset)))*1.05),
            fill = 'grey90', alpha = 0.25) + 
  geom_line(aes(x = dateTime, y = h.obs, linetype = 'Recorded', 
                color = factor(site_no)), size = 0.5) +
  geom_line(aes(x = dateTime, y = h.sim+offset, linetype = 'Simulated',
                color = factor(site_no)), size = 0.5) + 
  facet_wrap(~site_no, nrow = 4,
    labeller = labeller(site_no = function(x) paste('USGS', x))) + 
  scale_linetype_manual('Data Type', values = c(2,1)) + 
  scale_color_manual('USGS Gauge', guide = FALSE,
    values = scico(n = 5, palette = 'roma')[-3]) + 
  scale_x_datetime('Date', labels = function(z) gsub("^0", "", strftime(z, "%m/%d")),
    date_breaks = 'day', minor_breaks = 'day') +
  scale_y_origin('Water Surface (m)') + 
  theme_bw_custom() + 
  theme(strip.background = element_blank(),
        strip.text = element_text(color = 'black', size = 8),
        legend.position = 'bottom',
        legend.margin = margin(-5, 0, 0, 0),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
ggsave('_figures/fig07_timeseries.png', width = 6, height = 12, units = 'cm')

```


## Validate floodplain

note: need to create a separate script for flood_sonoma.Rdata

```{r}
#### compare LISFLOOD model vs. Sonoma GIS

## match rasters
lisflood <- raster('_sensitivity/surrogate/sherlock_casestudy/results/casestudy.max',
                   crs = projection(aoi)) %>% 
  overlay(dem.hydro, fun = function(x,y) ifelse(y < 1, NA, x))
lisflood.df <- lisflood %>% raster.df %>% filter(value > 0)

source('_data/flood_sonoma/flood_sonoma.R')
flood.sonoma <- flood_sonoma(45)*0.64 + flood_sonoma(46)*0.36
flood.df <- flood.sonoma %>%
  projectRaster(lisflood) %>%
  raster.df %>% filter(value > 0)

## wet/dry comparison
laguna <- (dem*0) %>% raster.df %>%
  mutate(value = case_when(
    x > 1924400 & y < 593000 ~ TRUE,
    x > 1925700 & y < 594000 ~ TRUE,
    x > 1926300 & y < 595000 ~ TRUE,
    TRUE ~ FALSE)) %>%
  rasterFromXYZ
flood.map <- flood.sonoma %>% 
  projectRaster(lisflood) %>% 
  overlay(lisflood, fun = function(x,y) {
    ifelse(x > 0 & y > 0, 0, ifelse (x > 0 & y <= 0, -1, ifelse(x <= 0 & y > 0, 1, NA)))})

```

```{r}
## calculate accuracy metrics
temp <- flood.sonoma %>% 
  projectRaster(lisflood) %>% 
  overlay(
    lisflood, fun = function(x,y) {
      ifelse(x > 0 & y > 0, 0, 
             ifelse (x > 0 & y <= 0, -1, 
                     ifelse(x <= 0 & y > 0, 1, NA))) 
    }) %>% 
  overlay(dem, fun = function(x,y) ifelse(y>1, x, NA)) 

tb <- table(temp[])
hitrate = tb[2] / sum(tb[1:2])
falsealarm = tb[3] / sum(tb[2:3])
fstat = tb[2] / sum(tb)
c('hitrate' = unname(hitrate), 
  'falsealarm' = unname(falsealarm), 
  'fstat' = unname(fstat)) %>% percent(accuracy = 0.01)

## get rid of Laguna de Santa Rosa & calculate again
temp.laguna <- temp %>% overlay(laguna, fun = function(x,y) ifelse(y, NA, x))
tb <- table(temp.laguna[])
hitrate = tb[2] / sum(tb[1:2])
falsealarm = tb[3] / sum(tb[2:3])
fstat = tb[2] / sum(tb)
c('hitrate' = unname(hitrate),
  'falsealarm' = unname(falsealarm),
  'fstat' = unname(fstat)) %>% percent(accuracy = 0.01)

```

```{r}
g11 <- ggplot() + 
  geom_sf(data = sonoma %>% st_union %>% st_crop(aoi),
    color = 'grey50', fill = 'grey95') + 
  geom_sf(data = aoi, color = 'black', fill = NA) + 
  geom_sf(
    data = flood.map %>% 
      raster.df %>% filter(!is.na(value)) %>% 
      rasterFromXYZ %>% extent %>% as('SpatialPolygons') %>% 
      st_as_sf %>% st_set_crs(6417), 
    fill = NA, color = 'black', linetype  = 'dotted') +
  geom_raster(
    data = flood.map %>% raster.df %>% filter(!is.na(value)),
    aes(x=x, y=y), fill = 'grey40', alpha = 0.5) +
  geom_raster(
    data = flood.map %>% 
      overlay(laguna, fun = function(x,y) ifelse(y, NA, x)) %>% 
      raster.df %>% filter(!is.na(value)),
    aes(x=x, y=y, fill = factor(value))) +
  scale_fill_manual(
    'Legend', values = scico(11, palette = 'lisbon')[c(3,6,10)],
    labels = c('False \nNegative', 'Correct', 'False \nPositive')) +
  annotation_scale(
    width_hint = 0.2, height = unit(0.25, 'cm'), text_cex = 2/3, 
    location = 'tl', pad_x = unit(0.5, 'cm'), pad_y = unit(0.1, 'cm')) +
  scale_y_continuous(expand = expansion(mult = c(0,0))) +
  theme_void() +
  theme(text = element_text(family = 'Segoe UI', size = 8),
        legend.position = 'bottom',
        legend.text = element_text(margin = margin(r = 10)),
        legend.margin = margin(0.1, 0.1, 0.1, 0.1, unit = 'cm'),
        legend.title = element_blank())
ggsave('_figures/fig07_floodmap.png', width = 6, height = 9, units = 'cm')

```

```{r}
load('_data/buildings/buildings.Rdata')

## check number of inundated buildings
buildings.coord <- buildings %>% 
  st_as_sf(coords = c('X', 'Y'), crs = 4269) %>% 
  st_transform(6417) %>% 
  st_coordinates
Sum(terra::extract(rast(flood.map), buildings.coord) >= 0) #simulated number
Sum(terra::extract(rast(flood.map), buildings.coord) <= 0) #"true" number

# ggplot() + 
#   geom_sf(data = sonoma %>% st_transform(6417) %>% st_crop(aoi),
#           color = 'grey70', fill = 'grey95') + 
#   geom_sf(data = aoi, color = 'black', fill = NA) + 
#   geom_sf(data = buildings %>% 
#             mutate(binary = unlist(terra::extract(rast(flood.map), buildings.coord))),
#           color = 'grey70')+ 
#   geom_sf(data = buildings %>% 
#             mutate(binary = unlist(terra::extract(rast(flood.map), buildings.coord))) %>% 
#             filter(!is.na(binary)),
#           aes(color = factor(binary)))

```

```{r}
flood.bldg <- cbind(
  rast(lisflood) %>% terra::extract(buildings.coord),
  rast(flood.sonoma %>% projectRaster(lisflood)) %>% terra::extract(buildings.coord)) %>% 
  setNames(c('sim', 'obs')) %>% 
  mutate(resid = sim-obs/mft) %>% 
  cbind(buildings.coord) %>% 
  filter(!is.na(resid)) %>% 
  filter(sim>0 | obs>0) %>% 
  arrange(abs(resid)) %>% 
  st_as_sf(coords = c('X', 'Y'), crs = 6417)

flood.bldg <- flood.bldg %>% 
  mutate(group = case_when(
    abs(resid) > 15 ~ 'big', 
    abs(resid) > 5 ~ 'med', 
    sim == 0 & obs == 0 ~ 'zero',
    TRUE ~ 'small'))
g12 <- ggplot(flood.bldg) + 
  geom_point(aes(x = obs/mft, y = sim)) + 
  # ggtitle('Observed vs. Simulated Inundation') +
  scale_x_origin('HEC-RAS Inundation (m)') + scale_y_origin('LISFLOOD Inundation (m)') + 
  geom_parity() + coord_fixed(clip = 'off')
ggsave('C:/Users/cbowers/Desktop/buildinginundation.png', width = 8.3, units = 'cm')

ggplot() +
  geom_sf(data = sonoma %>% st_transform(6417) %>% st_crop(aoi),
          color = 'grey70', fill = 'grey95') +
  geom_sf(data = aoi, color = 'black', fill = NA) +
  geom_sf(data = russian %>% st_transform(6417) %>% st_crop(aoi), size = 1) +
  geom_sf(data = flood.bldg, aes(color = resid)) +
  scale_color_scico(palette = 'roma',
    limits = c(-max(flood.bldg$resid), max(flood.bldg$resid)))

```

note: rewrite samples.Rmd

```{r}
# ## repeat the above plot, but with the surrogate model
# source('_scripts/INUN_sherlock.R')
# 
# ## get simulated inundation 
# hydrograph <- casestudy %>% mutate(n.AR = 1, n.precip = 1, n.hydro = 1)
# load('C:/Users/cbowers/Desktop/samples.Rdata')
# 
# num_cores <- 5
# cl <- parallel::makeCluster(num_cores)
# registerDoSNOW(cl)
# inundation <- 
#   generate_inundation(
#     hydrograph = hydrograph, 
#     buildings = buildings, 
#     probabilistic = TRUE, n.inun = 1e3
#   )
# stopCluster(cl)
# 
# ## get "real" inundation
# buildings$inun <- unlist(terra::extract(rast(flood.sonoma %>% projectRaster(dem)), buildings.coord))
# 
# temp <- inundation %>% do.call(cbind, .)
# 
# data.frame(
#   id = attr(inundation, 'wet.bldg'),
#   sim.05 = apply(temp, 1, function(x) quantile(x, 0.05)),
#   sim.25 = apply(temp, 1, function(x) quantile(x, 0.25)),
#   sim.med = apply(temp, 1, median), 
#   sim.75 = apply(temp, 1, function(x) quantile(x, 0.75)), 
#   sim.95 = apply(temp, 1, function(x) quantile(x, 0.95))) %>% 
#   full_join(buildings %>% st_drop_geometry %>% 
#               transmute(id = bldg, obs = inun/mft), by = 'id') %>% 
#   ggplot() + 
#   geom_segment(aes(x = obs, xend = obs, y = sim.05, yend = sim.95), color = 'grey70') + 
#   geom_point(aes(x = obs, y = sim.med)) + 
#   geom_parity()
  
```


# f(DM|INUN)

```{r}
## generate Wing et al. (2020) distributions
dx <- 0.01
beta.dist <- 
  map_dfc(.x = 1:nrow(wing2020), 
    .f = ~dbeta(x = seq(dx, 1-dx, dx), shape1 = wing2020$alpha[.x], 
                shape2 = wing2020$beta[.x])) %>%
    setNames(wing2020$depth_ft) %>% 
    mutate(damage_pct = seq(dx, 1-dx, dx)) %>% 
    pivot_longer(cols = -damage_pct, names_to = 'depth_ft', values_to = 'damage_prob') %>% 
    mutate(depth_ft = toNumber(depth_ft)) 

## generate Wing et al. (2020) random samples
beta.random <- 
  map_dfc(.x = 1:nrow(wing2020), 
    .f = ~rbeta(n = 100, shape1 = wing2020$alpha[.x], 
                shape2 = wing2020$beta[.x])) %>%
    setNames(wing2020$depth_ft) %>% 
    # mutate(damage_pct = seq(dx, 1-dx, dx)) %>%
    pivot_longer(cols = everything(), names_to = 'depth_ft', values_to = 'damage_prob') %>% 
    mutate(depth_ft = toNumber(depth_ft)) 

## plot distributions & random samples vs. HAZUS
g13 <- ggplot() + 
  ggridges::geom_density_ridges(
    data = beta.dist,
    aes(x = damage_pct, y = depth_ft, group = depth_ft, height = damage_prob,
        fill = 'Wing et al.'), 
    color = 'grey50', alpha = 0.6, stat = 'identity') + 
  # geom_point(
  #   data = beta.random,
  #   aes(x = damage_prob, y = jitter(depth_ft, factor = 1)), alpha = 0.35) +
  geom_line(
    data = hazus %>% filter(class == '1Struct' & Basement == 'N'), 
    aes(x = damage_pct/100, y = depth_ft, color = 'HAZUS'), size = 0.75) + 
  scale_color_manual('', values = 'black') + 
  scale_fill_manual('', values = 'grey70') + 
  scale_x_origin('Damage Ratio', labels = percent) + 
  scale_y_origin('First Floor Water Depth (m)', breaks = seq(0, 5, 0.5)*mft, 
                 labels = comma_format(accuracy = 0.1, scale = 1/mft)) + 
  coord_flip(clip = 'off') + 
  theme(legend.position = c(0.8, 0.72), 
        legend.margin = margin(-10, 0, -10, 0))

```


```{r}
load('_data/buildings/buildings.Rdata')
table(buildings$RESA_Status_GIS)

buildings <- buildings %>% 
  mutate(safety = case_when(
    RESA_Status_GIS == 'Green' ~ 'tagged/safe', 
    RESA_Status_GIS == 'Yellow' ~ 'tagged/unsafe',
    RESA_Status_GIS == 'Red' ~ 'tagged/unsafe',
    TRUE ~ 'untagged')) %>% 
  mutate(safety = factor(safety, levels = c('untagged', 'tagged/safe', 'tagged/unsafe')))
table(buildings$safety)

```

note: need to clean out buildings with duplicate ids. for now I'm just renaming them

```{r}
## calculate inundation due to the Sonoma inundation map 
buildings$inun <- 
  terra::extract(rast(flood.sonoma %>% projectRaster(dem)), 
                 st_coordinates(buildings)) %>% unlist

## calculate damage due to the Sonoma inundation map
buildings$bldg <- 1:nrow(buildings)
wet.bldg <- which(buildings$inun > 0)
inundation <- list(matrix(buildings$inun[wet.bldg]))
attributes(inundation)$n.inun <- NA
attributes(inundation)$buildings <-
  st_coordinates(buildings) %>%
  cbind(id = 1:nrow(.), .) %>%
  .[wet.bldg,]
attributes(inundation)$wet.bldg <- wet.bldg

## ignore the effect of randomly adding foundations
load('_data/foundations/foundations.Rdata')
nsi1.base <- data.frame(GEOID = nsi1.found$GEOID, 'All_0' = 1)

```

```{r}
source('_scripts/DM_sherlock.R')
# load('_data/depthdamage/depthdamage.Rdata')

cl <- parallel::makeCluster(num_cores)
registerDoSNOW(cl)

damage.beta <- generate_damage(
  inundation, 
  buildings = buildings %>% st_drop_geometry %>% rename(GEOID = tract),
  foundations = nsi1.base,
  curve = 'beta', 
  probabilistic = TRUE,
  n.damage = 1e3)
damage.beta <- damage.beta[[1]] %>% right_join(buildings %>% st_drop_geometry, ., by = 'bldg')

damage.hazus <- generate_damage(
  inundation, 
  buildings = buildings %>% st_drop_geometry %>% rename(GEOID = tract),
  foundations = nsi1.base,
  curve = 'hazus', 
  probabilistic = TRUE,
  n.damage = 1e3)
damage.hazus <- damage.hazus[[1]] %>% right_join(buildings %>% st_drop_geometry, ., by = 'bldg')

stopCluster(cl)

```

```{r}
g14 <- damage.beta %>% 
  mutate(dm = case_when(is.na(dm) ~ 0, TRUE ~ dm)) %>% 
  ggplot() + 
  geom_histogram(
    aes(x = dm, y = ..density.., fill = safety), boundary = 0, bins = 11,
    color = 'black', size = 0.25, show.legend = FALSE) + 
  facet_wrap(~factor(safety, levels = c('untagged', 'tagged/safe', 'tagged/unsafe')), nrow = 3) + 
  scale_fill_manual(
    breaks = c('untagged', 'tagged/safe', 'tagged/unsafe'),
    values = c('grey70', 'darkgreen', 'orangered')) + 
  scale_x_continuous('Wing et al. \nSimulated Damage Ratio', 
    limits = c(0,1), expand = expansion(mult = c(0,0)),
    labels = percent_format(accuracy = 1)) + 
  scale_y_origin('Average Frequency of Occurrence \n') + 
  theme(strip.background = element_blank(), 
        plot.margin = margin(10,10,10,10))

g15 <- damage.hazus %>% 
  mutate(dm = case_when(is.na(dm) ~ 0, TRUE ~ dm)) %>% 
  ggplot() + 
  geom_histogram(
    aes(x = dm, y = ..density.., fill = safety), boundary = 0, bins = 11,
    color = 'black', size = 0.25, show.legend = FALSE) + 
  facet_wrap(~factor(safety, levels = c('untagged', 'tagged/safe', 'tagged/unsafe')), nrow = 3) + 
  scale_fill_manual(
    breaks = c('untagged', 'tagged/safe', 'tagged/unsafe'),
    values = c('grey70', 'darkgreen', 'orangered')) + 
  scale_x_continuous('HAZUS \nSimulated Damage Ratio', 
    limits = c(0,1), expand = expansion(mult = c(0,0)),
    labels = percent_format(accuracy = 1)) + 
  scale_y_origin('Average Frequency of Occurrence \n') + 
  theme(strip.background = element_blank(),
        plot.margin = margin(10,10,10,10))


```

```{r}
plot_grid(
  g14, g15, nrow = 1, align = 'h',
  labels = c('(b)', '(c)'), label_fontfamily = 'Segoe UI', label_size = 12) %>% 
  plot_grid(g13, ., nrow = 2, rel_heights = c(3,5),
    labels = c('(a)', ''), label_fontfamily = 'Segoe UI', label_size = 12)
ggsave('_figures/fig08_damage.png', width = 8.3, height = 10, units = 'cm')

# plot_grid(g13, g14, g15, nrow = 1, align = 'h', rel_widths = c(2,1,1),
#           labels = paste0('(', letters[1:3], ')'), 
#           label_x = c(0, -0.08, -0.05), label_y = c(0.95, 0.99, 0.99),
#           label_fontfamily = 'Segoe UI')
# ggsave('C:/Users/cbowers/Desktop/damage.png', width = 8, height = 4)

```





