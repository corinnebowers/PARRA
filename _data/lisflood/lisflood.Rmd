---
title: "lisflood"
output: html_document
---

This script creates five files: 

* $russian.dem.asc$ is the ascii raster of the digital elevation file, to be used in LISFLOOD-FP modeling.
* $dem.Rdata$ is the same digital elevation file, stored in R raster format.
* $russian.width.asc$ is the ascii raster of the river width, to be used in LISFLOOD-FP modeling.
* $russian.n.asc$ is the ascii raster of the floodplain Manning's roughness coefficient, to be used in LISFLOOD-FP modeling.
* $edges.Rdata$ stores edge.in (dataframe with location & width of the study area inlet) and edge.out (dataframe with location & width of the study area outlet), to be used in LISFLOOD-FP modeling. 

Corinne Bowers

7/1/2021

```{r setup, include = FALSE}
## setup
knitr::opts_knit$set(root.dir = 'D:/1-PARRA')

```

```{r message = FALSE}
## setup information
source('_data/setup.R')

## load area of interest (aoi)
load('_data/aoi/aoi.Rdata')

```

```{r dem}
#### create russian.dem.asc ####

## load SonomaVegMap file (takes about half an hour)
# http://sonomavegmap.org/data-downloads/
# horizontal datum: NAD83, resolution = 3x3 feet, units = feet
# vertical datum: NAVD88 (Geoid 12A), RMSE = 0.03 meters (see metadata), units = feet 
# instructions: download all watersheds in the study area, 
  # then use the Mosaic to New Raster tool in ArcGIS Pro to combine
hydro <- raster('_data/lisflood/SonomaVegMap/SonomaVegMap.tif') 
hydro <- hydro %>% aggregate(10) %>% projectRaster(blank)

## convert vertical units from feet to meters
dem.hydro <- hydro / mft

## load topobathy file for ocean elevation
# https://www.arcgis.com/home/item.html?id=c753e5bfadb54d46b69c3e68922483bc
topobathy <- raster('_data/lisflood/topobathy/topobathy.tif') %>% projectRaster(blank)

## add topobathy file to dem
dem <- dem.hydro %>% overlay(topobathy, fun = function(x,y) ifelse(is.na(x), y, x))

## save out
save(dem.hydro, dem, file = '_data/lisflood/dem.Rdata')
writeRaster(dem, format = 'ascii', overwrite = TRUE, 
            filename = '_data/lisflood/russian.dem.asc')

```

```{r include = FALSE}
# ## check vertical units
# aoi %>%
#   st_sample(25) %>% st_sf %>%
#   elevatr::get_elev_point(.) %>%
#   mutate(hydro = terra::extract(rast(dem.hydro), st_coordinates(.)) %>% 
#            unlist %>% unname) %>% 
#   ggplot() + geom_point(aes(x = elevation, y = hydro)) + 
#   scale_x_origin('USGS Elevation (m)') + 
#   scale_y_origin('SonomaVegMap DEM Elevation (m)') + 
#   geom_parity() + coord_fixed()

# ## check topobathy location
# ggplot() +
#   geom_raster(data = raster.df(topobathy) %>% filter(!is.na(value)),
#               aes(x=x, y=y), fill = 'blue') +
#   geom_raster(data = raster.df(dem) %>% filter(!is.na(value)),
#               aes(x=x, y=y), fill = 'red', alpha = 0.5) +
#   coord_sf(crs = crs_dem)
# ## check topobathy elevation
# raster.df(topobathy) %>% rename(topobathy = value) %>% 
#   left_join(raster.df(dem) %>% rename(dem = value), by = c('x', 'y')) %>% 
#   filter(!is.na(topobathy) & !is.na(dem)) %>% 
#   ggplot() + geom_point(aes(x = dem, y = topobathy), color = 'grey70') + geom_parity()

```

```{r width}
#### create russian.width.asc ####

## load river polygons & HUC-12 watershed boundaries from National Hydrography Dataset
# https://www.usgs.gov/core-science-systems/ngp/national-hydrography/national-hydrography-dataset
hydropoly <- st_read('_data/NHD/NHD_H_California_State_GDB.gdb', 
                     layer = 'NHDArea', quiet = TRUE) %>% st_transform(6417)
fcode <- st_read('_data/NHD/NHD_H_California_State_GDB.gdb', 
                 layer = 'NHDFCode', quiet = TRUE)
wbd12 <- st_read('_data/NHD/NHD_H_California_State_GDB.gdb', 
                 layer = 'WBDHU12', quiet = TRUE)

## subset to only polygons associated with the Russian River
hydropoly_rr <- hydropoly %>% 
  left_join(fcode %>% select('FCODE', 'DESCRIPTION'), by = c('FCode' = 'FCODE')) %>% 
  mutate(id = 1:nrow(.)) %>%
  filter(grepl('Stream/River', DESCRIPTION)) %>% 
  filter(id == 2104) %>%  #Russian River
  st_transform(6417) %>% 
  st_intersection(st_transform(wbd12, 6417)) %>% 
  st_crop(aoi) %>% 
  st_cast('MULTIPOLYGON') %>% st_cast('POLYGON') %>%
  mutate(feature_id = row.names(.))
# mapview::mapview(hydropoly_rr, zcol = 'feature_id')
hydropoly_rr <- hydropoly_rr %>% 
  filter(!(feature_id %in% 
             c('1.19', '1.12.1', '1.11', '1.12', '1.2'))) %>% 
  select(feature_id, Shape) 

```

```{r}
#### find width using transects ####

## write hydropoly_rr to file for ArcGIS
# st_write(st_union(hydropoly_rr), dsn = '_temp/hydropoly_rr.shp', append = FALSE)

# instructions: run ArcGIS Polygon to Centerline tool on hydropoly_rr.shp,
  # then run Generate Transects Along Lines tool at 10m along the centerline

## load transects file
transect_10 <- 
  st_read('_data/lisflood/transect_10/transect_10.shp', quiet = TRUE) %>% 
  mutate(id = 1:nrow(.)) %>% 
  st_intersection(st_union(hydropoly_rr)) %>% 
  mutate(width = toNumber(st_length(.)))
width <- transect_10 %>% rasterize(blank, field = 'width', fun = mean)

```

```{r include = FALSE}
#### find width using polygon shapes (old method) ####
width2 <- hydropoly_rr %>%
  mutate(AREA = st_area(.),
       PERIMETER = lwgeom::st_perimeter(.),
       WIDTH = 2*AREA/PERIMETER) %>% 
  rasterize(y = blank, field = 'WIDTH')

ggplot(data.frame(new = width[], old = width2[])) + 
  geom_point(aes(x = new, y = old)) + 
  scale_x_origin() + scale_y_origin() + geom_parity()

```

```{r}
#### save out ####
writeRaster(width, format = 'ascii', overwrite = TRUE, 
            filename = '_data/lisflood/russian.width.asc')

```

```{r edges}
#### get inlet & outlet boundary edges ####

## define edge.in & edge.out dataframes
width.df <- as.data.frame(width, xy = TRUE) %>% subset(!is.na(layer))
edge.in <- width.df[which(width.df$y == max(width.df$y)),]
edge.out <- width.df[which(width.df$x == min(width.df$x)),]

## save out
save(edge.in, edge.out, file = '_data/lisflood/edges.Rdata')

```

