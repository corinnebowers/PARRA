---
title: "lisflood"
output: html_document
---

This script creates five files: 

* $russian.dem.asc$ is the ascii raster of the digital elevation file, to be used in LISFLOOD-FP modeling.
* $dem.Rdata$ is the same digital elevation file, stored in R raster format.
* $russian.width.asc$ is the ascii raster of the river width, to be used in LISFLOOD-FP modeling.
* $russian.n.asc$ is the ascii raster of the floodplain Manning's roughness coefficient, to be used in LISFLOOD-FP modeling.
* $edges.Rdata$ stores edge.in (dataframe with location & width of the study area inlet) and edge.out (dataframe with location & width of the study area outlet), to be used in LISFLOOD-FP modeling. 

Corinne Bowers

7/1/2021

```{r setup, include = FALSE}
## setup
knitr::opts_knit$set(root.dir = 'D:/1-PARRA/_data/')

```

```{r message = FALSE}
## setup information
source('setup.R')

## load area of interest (aoi)
load('aoi/aoi.Rdata')

```

```{r dem}
#### create russian.dem.asc ####

## create blank raster with desired resolution
blank <- raster(ext, resolution = c(40,40), crs = projection(aoi))

## load SonomaVegMap file (takes about half an hour)
# http://sonomavegmap.org/data-downloads/
# horizontal datum: NAD83, resolution = 3x3 feet, units = feet
# vertical datum: NAVD88 (Geoid 12A), RMSE = 0.03 meters (see metadata), units = feet 
# instructions: download all watersheds in the study area, 
  # then use the Mosaic to New Raster tool in ArcGIS Pro to combine
hydro <- raster('lisflood/SonomaVegMap.tif') 
hydro <- hydro %>% aggregate(10) %>% projectRaster(blank)

## convert vertical units from feet to meters
dem.hydro <- hydro / mft

## load topobathy file for ocean elevation
# https://www.arcgis.com/home/item.html?id=c753e5bfadb54d46b69c3e68922483bc
topobathy <- raster('lisflood/topobathy.tif') %>% 
  projectRaster(blank)

## add topobathy file to dem
dem <- dem.hydro %>% overlay(topobathy, fun = function(x,y) ifelse(is.na(x), y, x))

## save out
save(dem.hydro, dem, file = 'lisflood/dem.Rdata')
writeRaster(dem, format = 'ascii', overwrite = TRUE, filename = 'lisflood/russian.dem.asc')

```

```{r include = FALSE}
# ## check vertical units
# aoi %>%
#   st_sample(25) %>% st_sf %>%
#   elevatr::get_elev_point(.) %>%
#   mutate(hydro = terra::extract(rast(dem.hydro), st_coordinates(.)) %>% 
#            unlist %>% unname) %>% 
#   ggplot() + geom_point(aes(x = elevation, y = hydro)) + 
#   scale_x_origin('USGS Elevation (m)') + 
#   scale_y_origin('SonomaVegMap DEM Elevation (m)') + 
#   geom_parity() + coord_fixed()

# ## check topobathy location
# ggplot() +
#   geom_raster(data = raster.df(topobathy) %>% filter(!is.na(value)),
#               aes(x=x, y=y), fill = 'blue') +
#   geom_raster(data = raster.df(dem) %>% filter(!is.na(value)),
#               aes(x=x, y=y), fill = 'red', alpha = 0.5) +
#   coord_sf(crs = crs_dem)
# ## check topobathy elevation
# raster.df(topobathy) %>% rename(topobathy = value) %>% 
#   left_join(raster.df(dem) %>% rename(dem = value), by = c('x', 'y')) %>% 
#   filter(!is.na(topobathy) & !is.na(dem)) %>% 
#   ggplot() + geom_point(aes(x = dem, y = topobathy), color = 'grey70') + geom_parity()

```

```{r width}
#### create russian.width.asc ####

## load river polygons & HUC-12 watershed boundaries from National Hydrography Dataset
# https://www.usgs.gov/core-science-systems/ngp/national-hydrography/national-hydrography-dataset
hydropoly <- st_read('NHD/NHD_H_California_State_GDB.gdb', layer = 'NHDArea', quiet = TRUE) %>% 
  st_transform(6417)
fcode <- st_read('NHD/NHD_H_California_State_GDB.gdb', layer = 'NHDFCode', quiet = TRUE)
wbd12 <- st_read('NHD/NHD_H_California_State_GDB.gdb', layer = 'WBDHU12', quiet = TRUE)

## subset to only polygons associated with the Russian River
hydropoly_rr <- hydropoly %>% 
  left_join(fcode %>% select('FCODE', 'DESCRIPTION'), by = c('FCode' = 'FCODE')) %>% 
  subset(grepl('Stream/River', DESCRIPTION)) %>% 
  subset(row.names(.) == '2104') %>%  #get Russian River only
  sfheaders::sf_remove_holes(.) %>% 
  st_intersection(st_transform(wbd12, 6417)) %>% 
  mutate(feature_id = row.names(.)) %>% 
  subset(!(feature_id %in% c('2104', '2104.11', '2104.12', '2104.20'))) %>% 
  select(feature_id, Shape) 

## measure the average width of each polygon
hydropoly_rr <- hydropoly_rr %>%
  filter(feature_id %in% c('2104.16', '2104.17')) %>% 
  st_union %>% st_sf %>%
  transmute(feature_id = '2104.17', Shape = geometry) %>%
  st_drop_geometry %>%
  rbind(hydropoly_rr %>% filter(!(feature_id %in% c('2104.16', '2104.17')))) %>%
  st_sf %>% 
  st_crop(extent(blank)) %>% 
  st_cast('MULTIPOLYGON') %>% st_cast('POLYGON') %>% 
  mutate(feature_id = row.names(.)) %>% 
  filter(feature_id != '2104.14') %>% 
  mutate(AREA = st_area(.), 
         PERIMETER = lwgeom::st_perimeter(.),
         WIDTH = 2*AREA/PERIMETER)

## convert to the resolution of the dem raster
width <- hydropoly_rr %>% 
  st_cast(to = 'MULTILINESTRING') %>% 
  rasterize(y = blank, field = 'WIDTH')

## save out
writeRaster(width, format = 'ascii', overwrite = TRUE, filename = 'lisflood/russian.width.asc')

```

```{r edges}
#### get inlet & outlet boundary edges ####

## define edge.in & edge.out dataframes
width.df <- as.data.frame(width, xy = TRUE) %>% subset(!is.na(layer))
edge.in <- width.df[which(width.df$y == max(width.df$y)),]
edge.out <- width.df[which(width.df$x == min(width.df$x)),]

## save out
save(edge.in, edge.out, file = 'lisflood/edges.Rdata')

```

```{r manning}
#### create russian.n.asc ####

## get LULC codes
lulc <- FedData::get_nlcd(blank, label = 'value')
vals <- unique(lulc[])

## decide on roughness values for floodplain
# KS: Curtis (2016). Manning’s n Values for Various Land Covers: To Use for Dam Breach Analyses by NRCS in Kansas. Retrieved from https://www.wcc.nrcs.usda.gov/ftpref/wntsc/H&H/HecRAS/NEDC/lectures/docs/.
# JSH: Kalyanapu et al. (2009). Effect of land use-based surface roughness on hydrologic model output. Journal of Spatial Hydrology, 9(2), 51–71.
# MWR: Bunya et al. (2010). A high-resolution coupled riverine flow, tide, wind, wind wave, and storm surge model for southern Louisiana and Mississippi. Part I: Model development and validation. Monthly Weather Review, 138(2), 345–377. 
# all others: https://rashms.com/blog/mannings-n-roughness-coefficient-for-hec-ras-2d-modeling/
manning <- 
  read.csv('lisflood/manning.csv') %>% 
  setNames(c('name', 'code', names(.)[-(1:2)])) %>% 
  mutate(name = factor(name, levels = rev(name))) %>% 
  filter(code %in% vals) %>% 
  pivot_longer(cols = names(.)[-(1:2)], names_to = 'source', values_to = 'n') %>% 
  mutate(n.min = case_when(grepl('min', source) ~ n),
         n.max = case_when(grepl('max', source) ~ n)) %>% 
  mutate(source = source %>% gsub('_min', '', .) %>% gsub('_max', '', .)) %>% 
  group_by(name, code, source) %>% 
  summarize(n = n[1], n.min = Mean(n.min), n.max = Mean(n.max), .groups = 'drop') %>% 
  mutate(n.min = case_when(!is.nan(n.min) ~ n.min),
         n.max = case_when(!is.nan(n.max) ~ n.max)) 
manning_values <- manning %>% 
  filter(source != 'JSH' & source != 'TX') %>% 
  group_by(name, code) %>% 
  summarize(value = mean(n), .groups = 'drop') %>% 
  select(code, value)

## change LULC codes to roughness values
lulc.n <- lulc %>% reclassify(manning_values)

## convert to the resolution of the dem raster
lulc.dem <- projectRaster(lulc.n, blank)

## save out
writeRaster(lulc.dem, format = 'ascii', overwrite = TRUE, filename = 'lisflood/russian.n.asc')

```

```{r include = FALSE}
## choose which manning values fit best
manning %>% 
  filter(source != 'JSH') %>% 
  group_by(name, code) %>% 
  mutate(n.mean = mean(n)) %>% 
  ggplot() + 
  geom_line(aes(x = name, y = n, color = source, group = source), size = 1) + 
  geom_ribbon(aes(x = name, ymin = n.min, ymax = n.max, 
                  fill = source, group = source), alpha = 0.25) + 
  geom_point(aes(x = name, y = n.mean)) + 
  labs(x = '', y = 'Manning\'s Roughness Coefficient (n)') + 
  scale_y_origin(breaks = seq(0, 1, 0.05), minor_breaks = seq(0, 1, 0.05)) + 
  scale_color_manual(values = c(baker, 'grey50')) + 
  scale_fill_manual(values = c(baker, 'grey50')) + 
  coord_flip(clip = 'off') + 
  theme(panel.grid.major.x = element_line(color = 'grey90'))

```

