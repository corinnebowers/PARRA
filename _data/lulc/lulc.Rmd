---
title: "lulc"
output: html_document
---

The purpose of this script is...

# Setup

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = 'D:/1-PARRA/')
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

```

```{r}
## setup information
source('_data/setup.R')

## load required packages
require(FedData)

## load area of interest
load('_data/aoi/aoi.Rdata')

```

# Create LULC file for Sherlock analysis

```{r manning, include = FALSE}
#### create russian.n.asc ####

## get LULC codes as raster
lulc <- get_nlcd(blank, label = 'value')
vals <- unique(lulc[])

## convert raster to dataframe
lulc.df <- raster.df(lulc)

## save out
save(lulc, lulc.df, vals, file = '_data/lulc/lulc.Rdata')

```


# Identify candidate n values

The relationship between NLCD land cover categories and Manning's roughness coefficients have been estimated based on the following sources. Abbreviations refer to the abbreviations used in the figure below.

* KS: Curtis (2016). Manning’s n Values for Various Land Covers: To Use for Dam Breach Analyses by NRCS in Kansas. Retrieved from https://www.wcc.nrcs.usda.gov/ftpref/wntsc/H&H/HecRAS/NEDC/lectures/docs/.
* JSH: Kalyanapu et al. (2009). Effect of land use-based surface roughness on hydrologic model output. Journal of Spatial Hydrology, 9(2), 51–71.
* MWR: Bunya et al. (2010). A high-resolution coupled riverine flow, tide, wind, wind wave, and storm surge model for southern Louisiana and Mississippi. Part I: Model development and validation. Monthly Weather Review, 138(2), 345–377. 
* All others: https://rashms.com/blog/mannings-n-roughness-coefficient-for-hec-ras-2d-modeling/

```{r}
## decide on roughness values for floodplain
manning <- 
  read.csv('_data/manning.csv') %>% 
  setNames(c('name', 'code', names(.)[-(1:2)])) %>% 
  mutate(name = factor(name, levels = rev(name))) %>% 
  filter(code %in% vals) %>% 
  pivot_longer(cols = names(.)[-(1:2)], names_to = 'source', values_to = 'n') %>% 
  mutate(n.min = case_when(grepl('min', source) ~ n),
         n.max = case_when(grepl('max', source) ~ n)) %>% 
  mutate(source = source %>% gsub('_min', '', .) %>% gsub('_max', '', .)) %>% 
  group_by(name, code, source) %>% 
  summarize(n = n[1], n.min = Mean(n.min), n.max = Mean(n.max), .groups = 'drop') %>% 
  mutate(n.min = case_when(!is.nan(n.min) ~ n.min),
         n.max = case_when(!is.nan(n.max) ~ n.max)) 

## save out for Sherlock
manning %>% 
  group_by(name, code) %>% 
  summarize(n.min = Min(c(min(n), Min(n.min))), 
            n.max = Max(c(max(n), Max(n.max)))) %>% 
  left_join(manning %>% subset(source == 'HECRAS') %>% 
              transmute(name, code, default = n), by = c('name', 'code')) %>% 
  write.table(file = 'manning_values.txt', row.names = FALSE, col.names = TRUE, sep = '\t')


```

```{r}
## choose which manning values fit best
manning %>% 
  filter(source != 'JSH') %>% 
  group_by(name, code) %>% 
  mutate(n.mean = mean(n)) %>% 
  ggplot() + 
  geom_line(aes(x = name, y = n, color = source, group = source), size = 1) + 
  geom_ribbon(aes(x = name, ymin = n.min, ymax = n.max, 
                  fill = source, group = source), alpha = 0.25) + 
  # geom_point(aes(x = name, y = n.mean)) + 
  labs(x = '', y = 'Manning\'s Roughness Coefficient (n)') + 
  scale_y_origin(breaks = seq(0, 1, 0.05), minor_breaks = seq(0, 1, 0.05)) + 
  scale_color_manual(values = c(baker, 'grey50')) + 
  scale_fill_manual(values = c(baker, 'grey50')) + 
  coord_flip(clip = 'off') + 
  theme(panel.grid.major.x = element_line(color = 'grey90'))

```

# Create russian.n.asc

```{r}
manning_values <- manning %>% 
  filter(source != 'JSH' & source != 'TX') %>% 
  group_by(name, code) %>% 
  summarize(value = mean(n), .groups = 'drop') %>% 
  select(code, value)

## change LULC codes to roughness values
lulc.n <- lulc %>% reclassify(manning_values)

## convert to the resolution of the dem raster
lulc.dem <- projectRaster(lulc.n, blank)

# ## save out
# writeRaster(lulc.dem, format = 'ascii', overwrite = TRUE, filename = '_data/lisflood/russian.n.asc')

```

