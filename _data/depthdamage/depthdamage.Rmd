---
title: "depthdamage"
output: html_document
---

```{r setup, include = FALSE}
## setup
knitr::opts_knit$set(root.dir = 'D:/1-PARRA/_data/')

```

```{r message = FALSE}
## setup information
source('setup.R')

```

```{r}
## get HAZUS damage curves
hazus <- read.csv('depthdamage/HAZUS.csv')
hazus <- hazus %>% 
  filter(Curve != 'San Francisco') %>% 
  mutate(FIA = toNumber(gsub('FIA ', '', Curve))) %>% 
  subset(FIA > 1970) %>% 
  select(-Table, -Curve) %>% 
  pivot_longer(cols = -c('Stories', 'Basement', 'Type', 'FIA'), 
               names_to = 'depth_ft', values_to = 'damage_pct') %>% 
  mutate(depth_ft = depth_ft %>% gsub('\\.', '-', .) %>% 
           gsub('X', '', .) %>% toNumber) %>% 
  mutate(depth_m = depth_ft/mft) %>% 
  # filter(Basement == 'N' & Type == 'Struct') %>% 
  mutate(class = paste0(Stories, Type)) 

ggplot(hazus) + 
  geom_line(aes(x = depth_m, y = damage_pct, group = class, color = class), size = 1) + 
  scale_y_origin()
  
```

```{r}
## get FLEMO damage curves
flemo <- read.csv('depthdamage/FLEMO.csv')
flemo <- flemo %>% 
  mutate(depth_m = cm/100) %>% 
  select(-cm, -ft) %>% 
  pivot_longer(cols = -depth_m, names_to = 'class', values_to = 'damage_pct') %>% 
  filter(grepl(pattern = 'SFH', x = class)) 

ggplot(flemo) + 
  geom_line(aes(x = depth_m, y = damage_pct, group = class, color = class), size = 1) + 
  scale_y_origin()

```

```{r}
## get beta distribution parameters
wing2020 <- data.frame(
  depth_ft = c(1:5,7), 
  alpha = c(0.42, 0.48, 0.49, 0.53, 0.68, 0.80),
  beta = c(0.80, 0.65, 0.52, 0.41, 0.42, 0.38)) %>% 
  mutate(depth_m = depth_ft/mft)

find_nearest <- function(x, vector) {
  map_dbl(.x = x, .f = ~vector[which.min(abs(.x-vector))])
}

dx <- 0.01
map_dfc(.x = 1:nrow(wing2020), 
  .f = ~dbeta(x = seq(dx, 1-dx, dx), shape1 = wing2020$alpha[.x], 
              shape2 = wing2020$beta[.x])) %>%
  setNames(wing2020$depth_ft) %>% 
  mutate(damage_pct = seq(dx, 1-dx, dx)) %>% 
  pivot_longer(cols = -damage_pct, names_to = 'depth_ft', values_to = 'damage_prob') %>% 
  mutate(depth_ft = toNumber(depth_ft)) %>% 
  ggplot() + 
  ggridges::geom_density_ridges(
    aes(x = damage_pct, y = depth_ft, group = depth_ft, height = damage_prob), stat = 'identity') + 
  scale_y_origin()

# f.alpha <- lm(alpha ~ water_ft, data = wing2020)
# f.beta <- nls(beta ~ yf + (y0-yf)*exp(-alpha*water_ft), 
#               data = wing2020, 
#               start = list(y0 = 1, yf = 0, alpha = 1))
# beta.dist <- data.frame(water_ft = 1:20) %>% 
#   mutate(alpha = predict(f.alpha, data.frame(water_ft)), 
#          beta = predict(f.beta, data.frame(water_ft)), 
#          mu = alpha / (alpha + beta), 
#          sd = sqrt((alpha*beta) / ((alpha+beta)^2 * (alpha + beta + 1)))) %>% 
#   rbind(data.frame(water_ft = 0, alpha = NA, beta = NA, mu = 0, sd = 0), .)
# g1 <- ggplot() +
#   geom_line(data = beta.dist, aes(x = water_ft, y = alpha)) +
#   geom_point(data = wing2020, aes(x = water_ft, y = alpha)) +
#   scale_x_origin('Water Depth (ft)') + scale_y_origin('alpha') + 
#   theme_classic()
# g2 <- ggplot() +
#   geom_line(data = beta.dist, aes(x = water_ft, y = beta)) +
#   geom_point(data = wing2020, aes(x = water_ft, y = beta)) +
#   scale_x_origin('Water Depth (ft)') + scale_y_origin('beta') + 
#   theme_classic()
# gridExtra::grid.arrange(g1, g2, ncol = 2)

```

```{r}
## save out
save(hazus, flemo, wing2020, file = 'depthdamage/depthdamage.Rdata')

```

